set -e

REPOSITORY=$1

# Ensure ECR repository exists.
retry ensure_repo $REPOSITORY $ECR_REGION refresh_lifecycle

CONTENT_HASH=$(calculate_content_hash $REPOSITORY)
echo "Content hash: $CONTENT_HASH"

FINAL=$ECR_URL/$REPOSITORY:cache-$CONTENT_HASH

echo "Creating manifest list $FINAL..."

X86=$ECR_URL/$REPOSITORY-x86_64:cache-$CONTENT_HASH
ARM64=$ECR_URL/$REPOSITORY-arm64:cache-$CONTENT_HASH

docker manifest create $FINAL \
--amend $X86 \
--amend $ARM64

docker manifest push --purge $FINAL