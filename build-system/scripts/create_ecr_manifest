set -e

REPOSITORY=$1
FINAL_IMAGE_NAME=$2

# Ensure ECR repository exists.
retry ensure_repo $REPOSITORY $ECR_REGION refresh_lifecycle

CONTENT_HASH=$(calculate_content_hash $REPOSITORY)
echo "Content hash: $CONTENT_HASH"

FINAL=$ECR_URL/$FINAL_IMAGE_NAME:cache-$CONTENT_HASH

echo "Creating manifest list $FINAL..."

X86=$ECR_URL/$FINAL_IMAGE_NAME-x86_64:cache-$CONTENT_HASH
ARM64=$ECR_URL/$FINAL_IMAGE_NAME-arm64:cache-$CONTENT_HASH

export DOCKER_CLI_EXPERIMENTAL=enabled

docker manifest create $FINAL \
--amend $X86 \
--amend $ARM64

docker manifest push --purge $FINAL